<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.11 (454874)"/><meta name="author" content="jangseon.ryu@gmail.com"/><meta name="created" content="2017-05-09 21:15:22 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-05-09 21:30:59 +0000"/><title>Barbican Workshop</title></head><body><div><span>Barbican Workshop</span></div><div><br/></div><div dir="ltr"><span>Welcome to the Barbican Workshop for the OpenStack Summit in Boston.  This handout will be your guide for the workshop.  All exercises should be performed on the VM that you have been assigned.</span></div><div><br/></div><h1 dir="ltr"><span>Getting ready for the Workshop</span></h1><div dir="ltr"><span>There are two methods to access the VM assigned to you: with an SSH private key or with a username/password.  Use either method to access the VM.</span></div><div><br/></div><div><br/></div><ul><li style="font-size: 11pt; font-family: Arial; color: #000000;" dir="ltr"><span style="font-size: 11pt; font-family: Arial; color: #000000;">Option 1: Username/ Password</span><br/><br/></li></ul><div><br/></div><div dir="ltr"><span>$ ssh centos@&lt;YOUR_VM_IP&gt;</span></div><div><br/></div><div dir="ltr"><span>(password is barbicanr0x!)</span></div><div><br/></div><div><br/></div><ul><li style="font-size: 11pt; font-family: Arial; color: #000000;" dir="ltr"><span style="font-size: 11pt; font-family: Arial; color: #000000;">Option 2: SSH Private Key</span><br/><br/></li></ul><div dir="ltr"><span>First, download and save the key using wget, curl, or a browser.</span></div><div><br/></div><div dir="ltr"><span>The key is located at</span> <a href="https://goo.gl/ccYaOm">https://goo.gl/ccYaOm</a><span>, which expands to</span> <a href="https://raw.githubusercontent.com/cloudkeep/barbican-workshop/master/demo_student_keys.pem">https://raw.githubusercontent.com/cloudkeep/barbican-workshop/master/demo_student_keys.pem</a></div><div><br/></div><div><br/></div><table style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr style=""><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div dir="ltr"><span>Mac</span></div><div><br/></div></td><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px; width: 50%; min-width: 50%;"><div dir="ltr"><span>$ curl -o demo_student_keys.pem </span><a href="https://goo.gl/ccYaOm">https://goo.gl/ccYaOm</a></div><div><br/></div></td></tr><tr style=""><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px;"><div dir="ltr"><span>Linux</span></div><div><br/></div></td><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px;"><div dir="ltr"><span>$ wget -O demo_student_keys.pem </span><a href="https://goo.gl/ccYaOm">https://goo.gl/ccYaOm</a></div><div><br/></div></td></tr><tr style=""><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px;"><div dir="ltr"><span>Browser</span></div><div><br/></div></td><td style="border: 1pt solid rgb(0, 0, 0); padding: 10px; margin: 0px;"><div dir="ltr"><a href="https://goo.gl/ccYaOm">https://goo.gl/ccYaOm</a> <span>   (File, Save as…)</span></div><div><br/></div></td></tr></tbody></table><div><br/></div><div dir="ltr"><span>$ chmod 600 demo_student_keys.pem</span></div><div><br/></div><div dir="ltr"><span>$ ssh -i demo_student_keys.pem centos@&lt;YOUR_VM_IP&gt;</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>After logging in to your assigned VM, become the root user to run the configuration script that will install the Barbican, Keystone and Dogtag services.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>$ sudo su -</span></div><div><br/></div><div dir="ltr"><span># sh /root/setup_student_vm.sh</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>When the script completes you should have a working Barbican service.  Run a curl command to view the Barbican version info:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># curl -v</span> <a style="text-decoration: underline;" href="https://localhost:9311">https://localhost:9311</a> <span>| python -m json.tool</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 1 - Passphrases</span></h2><div dir="ltr"><span>Store and retrieve a Passphrase using the</span> <span style="font-weight: bold;">openstack</span> <span>command line client.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Sahara is the OpenStack project for provisioning a data-intensive application cluster, such as Hadoop or Spark, on top of OpenStack.  Sahara can be configured to store cluster-specific passphrases in Barbican.  The exercise has you manually follow the steps what Sahara is doing on the backend on the user’s behalf.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>First, you must load the Keystone authentication credentials into your environment:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># source openrc</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Store a passphrase:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret store --secret-type passphrase \</span></div><div><br/></div><div dir="ltr"><span>     --name 'my passphrase' --payload 'Pa$$phrasE'</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Save the</span> <span style="font-weight: bold;">secret_ref</span> <span>value, as it will be required to retrieve your passphrase later.</span></div><div><br/></div><div dir="ltr"><span>An easy way to store a passphrase in Barbican and save the</span> <span>secret_ref</span> <span>value in an environment variable is by using the</span> <span style="font-weight: bold;">-f (--format)</span> <span>and</span> <span style="font-weight: bold;">-c (--column)</span> <span>flags.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># SECRET_REF=$(openstack secret store --secret-type passphrase \</span></div><div><br/></div><div dir="ltr"><span>     --name "another passphrase" --payload 'Be77erPa$$phrazE' \</span></div><div><br/></div><div dir="ltr"><span>     -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Now you can retrieve the secret metadata by using the stored</span> <span style="font-weight: bold;">secret_ref</span><span>:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret get $SECRET_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Note that this only shows metadata.  To retrieve the actual passphrase payload you should use</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret get --payload $SECRET_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>To use the passphrase in a script you can use the -f and -c flags again:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># PASSPHRASE=$(openstack secret get --payload $SECRET_REF \</span></div><div><br/></div><div dir="ltr"><span>     -c payload -f value)</span></div><div><br/></div><div dir="ltr"><span># echo $PASSPHRASE</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 2 - Symmetric Encryption Keys</span></h2><div dir="ltr"><span>Store and retrieve an AES-256 Symmetric Encryption key.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>For the (work in progress) Swift encryption features, users configure Swift to retrieve a master symmetric key, given the key’s UUID.  The user can upload an existing key themselves, which is especially useful if they’ve already been using a local key and would like to upgrade to using a centralized key manager.  In this exercise, you will follow the commands to store a symmetric key.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>First, create a file containing a new random AES-256 encryption key:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># dd if=/dev/urandom of=aes_key bs=1 count=32</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Store the file as a new secret:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># SECRET_REF=$(openstack secret store \</span></div><div><br/></div><div dir="ltr"><span>     --secret-type 'symmetric' \</span></div><div><br/></div><div dir="ltr"><span>     --name 'AES-256 Encryption Key' \</span></div><div><br/></div><div dir="ltr"><span>     --file aes_key \</span></div><div><br/></div><div dir="ltr"><span>     -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>You can retrieve the metadata or download to a file using the secret get command:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret get $SECRET_REF</span></div><div><br/></div><div dir="ltr"><span># openstack secret get --file retrieved_key $SECRET_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>You can verify the retrieved key is identical to the original using the diff command:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># diff aes_key retrieved_key</span></div><div><br/></div><div><br/></div><h2 dir="ltr"><span>Exercise 3 - Secret Containers</span></h2><div dir="ltr"><span>Create a couple of Secrets and add them to a Secret Container.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Containers are a useful way to group a few Secrets together.  In this example, you will store two passphrases for production-ready external services in Barbican.  You can group them in a container so that you can easily retrieve all your production-related passphrases in one command.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>First create two secret passphrases and store the references in environment variables:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># DB_PASSWORD_REF=$(openstack secret store \</span></div><div><br/></div><div dir="ltr"><span>     --secret-type passphrase \</span></div><div><br/></div><div dir="ltr"><span>     --name "Prod DB Password" \</span></div><div><br/></div><div dir="ltr"><span>     --payload 'D4taba$ePassw0rd' -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># RABBIT_PASSWORD_REF=$(openstack secret store \</span></div><div><br/></div><div dir="ltr"><span>     --secret-type passphrase \</span></div><div><br/></div><div dir="ltr"><span>     --name "Prod RabbitMQ Password" \</span></div><div><br/></div><div dir="ltr"><span>     --payload 'Rabb1tMQPa$$worD' -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Next create the container and store the container_ref:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># CONTAINER_REF=$(openstack secret container create \</span></div><div><br/></div><div dir="ltr"><span>     --type generic \</span></div><div><br/></div><div dir="ltr"><span>     --name "Production Credentials" \</span></div><div><br/></div><div dir="ltr"><span>     --secret "db=$DB_PASSWORD_REF" \</span></div><div><br/></div><div dir="ltr"><span>     --secret "rabbit=$RABBIT_PASSWORD_REF" \</span></div><div><br/></div><div dir="ltr"><span>     -c container_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>At this point you can store only the</span> <span style="font-weight: bold;">container_ref</span><span>.  Since the container has the references to the secrets, you don’t have to store the individual</span> <span style="font-weight: bold;">secret_ref</span><span>s.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>To retrieve the container use this command:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret container get $CONTAINER_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Once you retrieve the container you can retrieve the individual secrets as in Exercise 1.</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 4 - Generating Symmetric Encryption Keys</span></h2><div dir="ltr"><span>Request and retrieve an AES-256 encryption key using an Order.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Volume encryption is one feature in OpenStack that uses symmetric encryption keys.  Cinder will request that Barbican creates a key when the volume is created and will associate the key ID with the volume metadata.  Then, Nova will retrieve the key and use it when attaching the volume to an instance.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Ephemeral disk encryption is another feature in OpenStack that uses symmetric encryption keys.  Nova will request key creation, will retrieve the key, and will use it when encrypting the LVM disks.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>This exercise has you manually follow the steps of what Cinder and Nova are doing on the backend.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Submit an order for the AES Key:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># ORDER_REF=$(openstack secret order create key \</span></div><div><br/></div><div dir="ltr"><span>     --name "Order for an AES key" \</span></div><div><br/></div><div dir="ltr"><span>     --algorithm aes --bit-length 256 \</span></div><div><br/></div><div dir="ltr"><span>     -c order_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Orders may take some time to be fulfilled by the Barbican service.  You can check the status of your order by retrieving the order metadata:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret order get $ORDER_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Once the order’s</span> <span style="font-weight: bold;">status</span> <span>changes from</span> <span style="font-weight: bold;">PENDING</span> <span>to</span> <span style="font-weight: bold;">ACTIVE</span> <span>the order metadata will include a</span> <span style="font-weight: bold;">secret_ref</span> <span>for the newly created secret.  You can retrieve the key just as in Example 2:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># SECRET_REF=$(openstack secret order get $ORDER_REF \</span></div><div><br/></div><div dir="ltr"><span>      -c secret_ref -f value)</span></div><div><br/></div><div dir="ltr"><span># openstack secret get --file ordered_key $SECRET_REF</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 5 - Generating RSA Keys</span></h2><div dir="ltr"><span>Request and retrieve an RSA private key using an order.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>For the Glance image signing and verification feature, the first step is to create an RSA key pair.  Then, the user should request a CA to create a certificate tied to the key pair.  Before the user uploads the image, they sign the image using the private key.  The user uploads the certificate to Barbican and adds the certificate UUID and the image signature to the image metadata.  When the image is uploaded, Glance will retrieve the certificate and use it to verify the signature of the image.  Nova can also be configured to verify the signature again before booting the image.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>This exercise shows an example of creating an RSA key pair, and exercise 6 shows an example of uploading a certificate.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Submit an order for a 4096-bit RSA key pair.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># ORDER_REF=$(openstack secret order create asymmetric \</span></div><div><br/></div><div dir="ltr"><span>     --algorithm rsa --bit-length 4096 \</span></div><div><br/></div><div dir="ltr"><span>     -c order_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Once the order’s</span> <span style="font-weight: bold;">status</span> <span>changes to</span> <span style="font-weight: bold;">ACTIVE</span> <span>the order metadata will include a</span> <span style="font-weight: bold;">container_ref</span> <span>for the newly created RSA Secret Container</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># RSA_CONTAINER_REF=$(openstack secret order get $ORDER_REF \</span></div><div><br/></div><div dir="ltr"><span>      -c container_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Retrieve the public key and save it to a file:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># PUBLIC_KEY_REF=$(openstack secret container get \</span></div><div><br/></div><div dir="ltr"><span>     $RSA_CONTAINER_REF -c public_key -f value)</span></div><div><br/></div><div dir="ltr"><span># openstack secret get --file rsa.pub $PUBLIC_KEY_REF</span></div><div><br/></div><div dir="ltr"><span># cat rsa.pub</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Retrieve the private key and save it to a file:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># PRIVATE_KEY_REF=$(openstack secret container get \</span></div><div><br/></div><div dir="ltr"><span>     $RSA_CONTAINER_REF -c private_key -f value)</span></div><div><br/></div><div dir="ltr"><span># openstack secret get --file rsa $PRIVATE_KEY_REF</span></div><div><br/></div><div dir="ltr"><span># cat rsa</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 6 - x.509 Certificates</span></h2><div dir="ltr"><span>Create a self-signed x.509 certificate and upload all parts.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>LBaaS relies on Barbican to store the both the public and the private data necessary to decrypt TLS connections on the Load Balancer. The user uploads their private key, certificate, and any necessary intermediates into a Barbican certificate container. LBaaS understands the certificate container format, and only needs the container's ID when creating a TLS Terminating Load Balancer.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>First, generate the new key that will be used to sign the certificate and convert it to PKCS#8 format:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openssl genrsa -out private.pem 4096</span></div><div><br/></div><div dir="ltr"><span># openssl pkcs8 -topk8 -in private.pem -out private.pk8 -nocrypt</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Store the PKCS#8 formatted private key.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># PRIVATE_REF=$(openstack secret store \</span></div><div><br/></div><div dir="ltr"><span>     --secret-type private \</span></div><div><br/></div><div dir="ltr"><span>     --name 'Private Key for Certificate' \</span></div><div><br/></div><div dir="ltr"><span>     --file private.pk8 \</span></div><div><br/></div><div dir="ltr"><span>     -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Next, use openssl to generate the self-signed certificate:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openssl req -new -x509 -days 365 -key private.pk8 -out cert.pem</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Upload the certificate:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># CERT_REF=$(openstack secret store \</span></div><div><br/></div><div dir="ltr"><span>     --secret-type certificate \</span></div><div><br/></div><div dir="ltr"><span>     --name '</span><a href="http://myhost.com">myhost.com</a><span> certificate' \</span></div><div><br/></div><div dir="ltr"><span>     --file cert.pem \</span></div><div><br/></div><div dir="ltr"><span>     -c secret_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Now create a certificate type container using the private key and certificate references:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># CONTAINER_REF=$(openstack secret container create \</span></div><div><br/></div><div dir="ltr"><span>     --type certificate \</span></div><div><br/></div><div dir="ltr"><span>     --name 'Self-signed Certificate Bundle' \</span></div><div><br/></div><div dir="ltr"><span>     --secret "certificate=$CERT_REF" \</span></div><div><br/></div><div dir="ltr"><span>     --secret "private_key=$PRIVATE_REF" \</span></div><div><br/></div><div dir="ltr"><span>     -c container_ref -f value)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>To retrieve the certificate container use this command:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret container get $CONTAINER_REF</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Once you retrieve the container you can retrieve the individual secrets as in Exercise 1.</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 7 - Flask Application</span></h2><div dir="ltr"><span>In this exercise, we’ll run a Flask application to simulate on a small scale what integrating Barbican using Castellan will look like in your project.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Open port 8000 on the VM:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># firewall-cmd --zone=public --add-port=8000/tcp --permanent</span></div><div><br/></div><div dir="ltr"><span># firewall-cmd --reload</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Activate the virtual environment:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># source /root/new_flask/flask_app_venv/bin/activate</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Create a random string:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># SECRET=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Store the random string in Barbican:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># openstack secret store --payload $SECRET</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Save the secret UUID as an environment variable.  The UUID is the last part of the secret ref that was printed after creating the secret.  It should be in the format of 00000000-0000-0000-0000-000000000000:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># export OS_SECRET_UUID=&lt;secret_uuid&gt;</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Ensure all the requirements are installed:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># cd /root/new_flask/hide-your-tweets</span></div><div><br/></div><div dir="ltr"><span># pip install -r requirements.txt</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Change directories and run the server:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># cd /root/new_flask/hide-your-tweets/src</span></div><div><br/></div><div dir="ltr"><span># python </span><a href="http://server.py">server.py</a></div><div><br/></div><div><br/></div><div dir="ltr"><span>As long as the server is running, there should be a webapp available at &lt;your-vm-ip&gt;:8000.  Try entering a message to encrypt.  Please note that the tweet must be less than 15 characters.  The web app will use your randomly generated secret to encrypt the Tweet.  If you wish, you can log into Twitter and post the tweet.  If you don’t have a Twitter account or don’t wish to post the tweet, you can copy the tweet to your clipboard.  When you need to decrypt the tweet, copy the encrypted text and paste it into the web app.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>Note the castellan.conf file in hide-your-tweets/src.  Similarly to OpenStack projects, this is where you can configure Castellan.  For example, when you need to configure Nova to use Barbican, you will use the same [key_manager] section that can be found in this castellan.conf.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>At the end of the exercise, deactivate the virtual environment:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>        </span><span># deactivate</span></div><div><br/></div><h2 dir="ltr"><span>Exercise 8 - HSM Integration</span></h2><div dir="ltr"><span>Users sometimes need their secrets to be stored in a Hardware Security Module (HSM) to provide an extra level of security.  HSMs enforce process isolation - allowing secrets to be retrieved only through strictly defined interfaces and widely accepted algorithms, and provide tamper detection and resistance.  They will typically comply with standards like FIPS-140-1 and Common Criteria.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>In this exercise, you will connect Barbican to a Dogtag instance that has been configured to store its key encryption keys in a Thales nShield 6000 HSM.  This involves simply changing the Dogtag plugin configuration in /etc/barbican.conf to point to the relevant Dogtag instance, which is currently hosted in a public VM in the OVH cloud.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>The credentials to connect to the HSM (agent certificate) have already been copied to /etc/barbican by the setup script.  In addition, the CA certificate for the remote Dogtag instance has already been added to the trusted certificate bundle at</span> <span>/etc/ssl/certs/ca-bundle.trust.crt.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>To minimize typing errors, the changes have been encapsulated in a simple script.  To use the remote Dogtag instance, simply run the following script and restart the barbican service:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># /root/convert_to_dogtag_with_hsm.sh</span></div><div><br/></div><div dir="ltr"><span>          </span><span># systemctl restart httpd.service</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>It should now be possible to store and retrieve secrets by following the steps in Exercises 1-7.  Note that due to a current bug in Dogtag code, the private key of an asymmetric key pair that is generated on a Thales nShield HSM (as in Exercise 5) cannot be extracted.  This will be fixed soon.</span></div><div><br/></div><div><br/></div><div dir="ltr"><span>If you wish to re-configure the Barbican instance to talk to the local Dogtag instance, then run the following script and restart the barbican service:</span></div><div><br/></div><div><br/></div><div dir="ltr"><span># /root/convert_to_local_dogtag.sh</span></div><div><br/></div><div dir="ltr"><span>    # systemctl restart httpd.service</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# curl -v https://localhost:9311 | python -m json.tool</div><div>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div>                                 Dload  Upload   Total   Spent    Left  Speed</div><div>  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* About to connect() to localhost port 9311 (#0)</div><div>*   Trying ::1...</div><div>* Connection refused</div><div>*   Trying 127.0.0.1...</div><div>* Connected to localhost (127.0.0.1) port 9311 (#0)</div><div>* Initializing NSS with certpath: sql:/etc/pki/nssdb</div><div>*   CAfile: /etc/pki/tls/certs/ca-bundle.crt</div><div>  CApath: none</div><div>* SSL connection using TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</div><div>* Server certificate:</div><div>*     subject: OU=OpenStack,O=Red Hat Inc.,L=Raleigh,ST=North Carolina,C=US,CN=127.0.0.1</div><div>*     start date: Oct 29 22:03:56 2016 GMT</div><div>*     expire date: Oct 27 22:03:56 2026 GMT</div><div>*     common name: 127.0.0.1</div><div>*     issuer: OU=OpenStack,O=Red Hat Inc.,L=Raleigh,ST=North Carolina,C=US,CN=127.0.0.1</div><div>&gt; GET / HTTP/1.1</div><div>&gt; User-Agent: curl/7.29.0</div><div>&gt; Host: localhost:9311</div><div>&gt; Accept: */*</div><div>&gt;</div><div>  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0&lt; HTTP/1.1 300 Multiple Choices</div><div>&lt; Date: Tue, 09 May 2017 21:19:42 GMT</div><div>&lt; Server: Apache/2.4.6 (CentOS)</div><div>&lt; Content-Length: 349</div><div>&lt; Connection: close</div><div>&lt; Content-Type: application/json</div><div>&lt;</div><div>{ [data not shown]</div><div>100   349  100   349    0     0    198      0  0:00:01  0:00:01 --:--:--   198</div><div>* Closing connection 0</div><div>{</div><div>    "versions": {</div><div>        "values": [</div><div>            {</div><div>                "id": "v1",</div><div>                "links": [</div><div>                    {</div><div>                        "href": "https://127.0.0.1:9311/v1/",</div><div>                        "rel": "self"</div><div>                    },</div><div>                    {</div><div>                        "href": "https://docs.openstack.org/",</div><div>                        "rel": "describedby",</div><div>                        "type": "text/html"</div><div>                    }</div><div>                ],</div><div>                "media-types": [</div><div>                    {</div><div>                        "base": "application/json",</div><div>                        "type": "application/vnd.openstack.key-manager-v1+json"</div><div>                    }</div><div>                ],</div><div>                "status": "stable",</div><div>                "updated": "2015-04-28T00:00:00Z"</div><div>            }</div><div>        ]</div><div>    }</div><div>}</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# ls</div><div>0001-Make-cliff-output-match-the-actual-field-names.patch  hsm_config.tar.gz</div><div>0002-Add-file-flag-for-secrets.patch                       new_flask</div><div>389.inf                                                    openrc</div><div>convert_to_dogtag_with_hsm.sh                              scenario.pp</div><div>convert_to_local_dogtag.sh                                 setup_student_vm.sh</div><div>create_admin_cert_pem                                      spawn.cfg</div><div>flask.tar.gz                                               transport.pem</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# source openrc</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret store --secret-type passphrase \</div><div>&gt;       --name 'my passphrase' --payload 'Pa$$phrasE'</div><div>+---------------+----------------------------------------------------------------------+</div><div>| Field         | Value                                                                |</div><div>+---------------+----------------------------------------------------------------------+</div><div>| secret_ref    | https://127.0.0.1:9311/v1/secrets/0d5b4a27-6acf-                     |</div><div>|               | 42f6-9ee4-fd8cb25f9ff8                                               |</div><div>| name          | my passphrase                                                        |</div><div>| created       | None                                                                 |</div><div>| status        | None                                                                 |</div><div>| content_types | None                                                                 |</div><div>| algorithm     | aes                                                                  |</div><div>| bit_length    | 256                                                                  |</div><div>| secret_type   | passphrase                                                           |</div><div>| mode          | cbc                                                                  |</div><div>| expiration    | None                                                                 |</div><div>+---------------+----------------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# SECRET_REF=$(openstack secret store --secret-type passphrase \</div><div>&gt;       --name "another passphrase" --payload 'Be77erPa$$phrazE' \</div><div>&gt;       -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# echo $SECRET_REF</div><div><a href="https://127.0.0.1:9311/v1/secrets/6286eebb-19fa-4426-8333-1a6acea6c195">https://127.0.0.1:9311/v1/secrets/6286eebb-19fa-4426-8333-1a6acea6c195</a></div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get $SECRET_REF</div><div>+---------------+----------------------------------------------------------------------+</div><div>| Field         | Value                                                                |</div><div>+---------------+----------------------------------------------------------------------+</div><div>| secret_ref    | https://127.0.0.1:9311/v1/secrets/6286eebb-                          |</div><div>|               | 19fa-4426-8333-1a6acea6c195                                          |</div><div>| name          | another passphrase                                                   |</div><div>| created       | 2017-05-09 21:20:30+00:00                                            |</div><div>| status        | ACTIVE                                                               |</div><div>| content_types | {u'default': u'text/plain'}                                          |</div><div>| algorithm     | aes                                                                  |</div><div>| bit_length    | 256                                                                  |</div><div>| secret_type   | passphrase                                                           |</div><div>| mode          | cbc                                                                  |</div><div>| expiration    | None                                                                 |</div><div>+---------------+----------------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get --payload $SECRET_REF</div><div>+---------+------------------+</div><div>| Field   | Value            |</div><div>+---------+------------------+</div><div>| payload | Be77erPa$$phrazE |</div><div>+---------+------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# PASSPHRASE=$(openstack secret get --payload $SECRET_REF \</div><div>&gt;       -c payload -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# echo $PASSPHRASE</div><div>Be77erPa$$phrazE</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# dd if=/dev/urandom of=aes_key bs=1 count=32</div><div>32+0 records in</div><div>32+0 records out</div><div>32 bytes (32 B) copied, 0.000441031 s, 72.6 kB/s</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# cat aes_key</div><div>Q�TS�i��ز:��N`ts&gt;����    "Ό���^[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# SECre \REF=$(openstack secret sto</div><div>&gt;       --secret-type 'symmetric' \</div><div>&gt;       --name 'AES-256 Encryption Key' \</div><div>&gt;       --file aes_key \</div><div>&gt;       -c secret_ref -f value)</div><div><br/></div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get $SECRET_REF</div><div>+---------------+----------------------------------------------------------------------+</div><div>| Field         | Value                                                                |</div><div>+---------------+----------------------------------------------------------------------+</div><div>| secret_ref    | https://127.0.0.1:9311/v1/secrets/4ac2f28c-                          |</div><div>|               | cc60-4300-8436-75fa9b16ffa6                                          |</div><div>| name          | AES-256 Encryption Key                                               |</div><div>| created       | 2017-05-09 21:21:53+00:00                                            |</div><div>| status        | ACTIVE                                                               |</div><div>| content_types | {u'default': u'application/octet-stream'}                            |</div><div>| algorithm     | aes                                                                  |</div><div>| bit_length    | 256                                                                  |</div><div>| secret_type   | symmetric                                                            |</div><div>| mode          | cbc                                                                  |</div><div>| expiration    | None                                                                 |</div><div>+---------------+----------------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get --file retrieved_key $SECRET_REF</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# diff aes_key retrieved_key</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# DB_PASSWORD_REF=$(openstack secret store \</div><div>&gt;       --secret-type passphrase \</div><div>&gt;       --name "Prod DB Password" \</div><div>&gt;       --payload 'D4taba$ePassw0rd' -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# RABBIT_PASSWORD_REF=$(openstack secret store \</div><div>&gt;       --secret-type passphrase \</div><div>&gt;       --name "Prod RabbitMQ Password" \</div><div>&gt;       --payload 'Rabb1tMQPa$$worD' -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# CONTAINER_REF=$(openstack secret container create \</div><div>&gt;       --type generic \</div><div>&gt;       --name "Production Credentials" \</div><div>&gt;       --secret "db=$DB_PASSWORD_REF" \</div><div>&gt;       --secret "rabbit=$RABBIT_PASSWORD_REF" \</div><div>&gt;       -c container_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret container get $CONTAINER_REF</div><div><br/></div><div>+---------------+----------------------------------------------------------------------+</div><div>| Field         | Value                                                                |</div><div>+---------------+----------------------------------------------------------------------+</div><div>| container_ref | https://127.0.0.1:9311/v1/containers/d136b0bd-                       |</div><div>|               | d2c3-41d1-9125-449287337069                                          |</div><div>| name          | Production Credentials                                               |</div><div>| created       | 2017-05-09 21:22:50+00:00                                            |</div><div>| status        | ACTIVE                                                               |</div><div>| type          | generic                                                              |</div><div>| secrets       | db=https://127.0.0.1:9311/v1/secrets/a4523ec6-4755-4d8e-abca-        |</div><div>|               | 4a04a83a11a3                                                         |</div><div>|               | rabbit=https://127.0.0.1:9311/v1/secrets/c9c4bc6a-6f03-47fd-a9ef-    |</div><div>|               | 7ab156977e97                                                         |</div><div>| consumers     | None                                                                 |</div><div>+---------------+----------------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# ORDER_REF=$(openstack secret order create key \</div><div>&gt;       --name "Order for an AES key" \</div><div>&gt;       --algorithm aes --bit-length 256 \</div><div>&gt;       -c order_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret order get $ORDER_REF</div><div>+-------------------+------------------------------------------------------------------+</div><div>| Field             | Value                                                            |</div><div>+-------------------+------------------------------------------------------------------+</div><div>| order_ref         | https://127.0.0.1:9311/v1/orders/d626ccec-ceed-46b4-8eac-        |</div><div>|                   | 4a722a683413                                                     |</div><div>| type              | key                                                              |</div><div>| container_ref     |                                                                  |</div><div>| secret_ref        | https://127.0.0.1:9311/v1/secrets/531556f9-54ca-415f-907c-       |</div><div>|                   | f334c8cbb586                                                     |</div><div>| created           | 2017-05-09 21:23:33+00:00                                        |</div><div>| status            | ACTIVE                                                           |</div><div>| error_status_code | None                                                             |</div><div>| error_reason      | None                                                             |</div><div>+-------------------+------------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# SECRET_REF=$(openstack secret order get $ORDER_REF \</div><div>&gt;        -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get --file ordered_key $SECRET_REF</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# cat ordered_key</div><div>g3@�ش�;�=��t�R��F�8��Ώf��s�[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# ORDER_REF=$(openstack secret order create asymmetric \</div><div>&gt;       --algorithm rsa --bit-length 4096 \</div><div>&gt;       -c order_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# RSA_CONTAINER_REF=$(openstack secret order get $ORDER_REF \</div><div>&gt;        -c container_ref -f value)</div><div><br/></div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# PUBLIC_KEY_REF=$(openstack secret container get \</div><div>&gt;       $RSA_CONTAINER_REF -c public_key -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get --file rsa.pub $PUBLIC_KEY_REF</div><div><br/></div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# cat rsa.pub</div><div>-----BEGIN PUBLIC KEY-----</div><div>MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxe9saAP9WCO/NlMEwo0Q</div><div>dVIlGWk21nFVe0+TgvpGbmqPw15ZzTTy9RhcXwJAXxgXWOZPF4n7D8MMxwLxnZ1x</div><div>fLnXE5S0+5Yo+UBuECLmAyxgsZxZ+Pfs6T7dZlOtv3yms7nIyoWP17gRAOih8qcg</div><div>FqYU7tnrZFuP/zgEBih+ubLo+qLH64VRhkegC6s2U2spURP6ECBI2Fd+lIWtn9kR</div><div>WUHhUP1+x5nUhnV6+YmSJpHDuQhUZFx1mwSD00IyNyTyiY4Rn8IZKlOf0VJNw5mR</div><div>nbqmu+n5d1uVdA4UtUOxss8E03YwiPridM4Dr662KOmKzgFmYyVVyJv3HLIdSOd1</div><div>vw5NLkDgJqExvumqCaOir0m1KeisKewBrvy34w7EB/glqulRUPghw64nfaWSaxT6</div><div>npVRN12zUI0eyVS3Fjodmc/3wc/eNYWTJgpqIkz6CMntCP6c0XqtWmEa6oVzKypu</div><div>NmsJkWvNDfXTxLshYMAYUrLDDtne/p9ZqiAt9nlqn5C0D5rRU/DwzhoS+HJOVH+P</div><div>iNPHWUV7DYQQ/3N3E5d9NiSgf8ip3GwQj+kPRyE8FtP7nDkEYXlsZ5k1SFjJG71d</div><div>flCuTWbTv2VEa1sP/25l/D/sytrHP/wddppuHsBfgZUO5A4zb5679AAKP5TRFupE</div><div>GGELqBSQFfGDI+hkR0+ePnECAwEAAQ==</div><div>-----END PUBLIC KEY-----[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# PRIVATE_Kt container get \k secre</div><div>&gt;       $RSA_CONTAINER_REF -c private_key -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret get --file rsa $PRIVATE_KEY_REF</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# cat rsa</div><div>-----BEGIN PRIVATE KEY-----</div><div>MIIJQgIBADANBgkqhkiG9w0BAQEFAASCCSwwggkoAgEAAoICAQDF72xoA/1YI782</div><div>UwTCjRB1UiUZaTbWcVV7T5OC+kZuao/DXlnNNPL1GFxfAkBfGBdY5k8XifsPwwzH</div><div>AvGdnXF8udcTlLT7lij5QG4QIuYDLGCxnFn49+zpPt1mU62/fKazucjKhY/XuBEA</div><div>6KHypyAWphTu2etkW4//OAQGKH65suj6osfrhVGGR6ALqzZTaylRE/oQIEjYV36U</div><div>ha2f2RFZQeFQ/X7HmdSGdXr5iZImkcO5CFRkXHWbBIPTQjI3JPKJjhGfwhkqU5/R</div><div>Uk3DmZGduqa76fl3W5V0DhS1Q7GyzwTTdjCI+uJ0zgOvrrYo6YrOAWZjJVXIm/cc</div><div>sh1I53W/Dk0uQOAmoTG+6aoJo6KvSbUp6Kwp7AGu/LfjDsQH+CWq6VFQ+CHDrid9</div><div>pZJrFPqelVE3XbNQjR7JVLcWOh2Zz/fBz941hZMmCmoiTPoIye0I/pzReq1aYRrq</div><div>hXMrKm42awmRa80N9dPEuyFgwBhSssMO2d7+n1mqIC32eWqfkLQPmtFT8PDOGhL4</div><div>ck5Uf4+I08dZRXsNhBD/c3cTl302JKB/yKncbBCP6Q9HITwW0/ucOQRheWxnmTVI</div><div>WMkbvV1+UK5NZtO/ZURrWw//bmX8P+zK2sc//B12mm4ewF+BlQ7kDjNvnrv0AAo/</div><div>lNEW6kQYYQuoFJAV8YMj6GRHT54+cQIDAQABAoICABqxG4uYVCL9aRT0k4z/1GMZ</div><div>0X5wgZBgBrDDDaepQ/OyY5IrSE1jsUrLfvNh/JfGSim3Hx3TwdtBiJjSxQ3l9C6n</div><div>agFOOay+tmZMYbtD1YRCiQSSitCH8HcQvu8EZEcREnLkoBbtdXUX8ZUPif1Mu8dK</div><div>HMML+JIXRd8bKPHCpro4jfH0nySb3R9QS90e+Mu9hPwVx1BC5kfkXqG9OCl47n28</div><div>pFuVX7IfhLkgIRYDDwYr/HqYjLbfAA4ISRWlVNu6XAmgMrC6TkX2snPaFzoEHM6q</div><div>I79uATHvFAOrPXAnQZCVGbfBdbCXMpAhUv5vP0nbmpgGuM2wdHXB0IxaWZgh/G7r</div><div>OhZir2Nhx5vqNuXhPUOAHi1CwYWB6WPV/jLFmxECakgRGT+VK8ru98Ju5cciu+nY</div><div>HtsBB6Exa6GDXF2jadnKhVIUupCrWtnFEYDa0Egxy6rA91yJxHo8Ju25JYfrcFJA</div><div>UGG4NsOT9/DFiVd/i3zCNGJmeo+oDv3uOu5nmlMzyzO9AkB2/dQteaqIE1L8FkwL</div><div>MJGvBfl1VOBUtlPpCEolHZ4IuftP0pdYGU4QS/mSUTruTSlVkHSfWYYFn8MqLVx/</div><div>o1jLi3y9QL3fgYJHsuDfEeXUVbW60EnARXdu+Gv2Hssp7Gc7Cl4bKZJq7npUexZ8</div><div>xuPLcwTJaA+tlIP6sReFAoIBAQDuKrm3pXulxwxy7G+u+0Lxh1Z/GIrTuGqoHLDZ</div><div>bx4A3Z54KirEsHXPaOk/koqLNh37H/uq76BMZx7Iyp7ANH4nog5CtA/39SSoAM3y</div><div>z1pS4OlCvgc4Cg6jdlHgSxHjZMZXRRIq/gv+9xZFavWXqsNmN2j0yC42TzU/E9E8</div><div>KjSbMU4YFkV1DM2PgoKG64FCyqnn5dGZLbp1yilWyNY9uL5EUmdi8HRDnVkXnIFu</div><div>tSWGZfHketPsaLZ3Yuai/Ja3ZG/X6Nd20jwOcWivwhWR4vMCs51qFJC+v1xghbt0</div><div>rIz6m1if9jvZcX3t7FDMNl1BdIyXi0V5sDQXrfJxpn5jJORVAoIBAQDUwYW2blIb</div><div>iKhQ7hpyoDQdyqXFKTgmOrfuusMZEnm/6vFtRP59cQal5iiB8jub5F0HwLzT5CHF</div><div>irgYkUl2O2ziPjxFx4LOb86m1Hq3cym+rbwVsUiJY3IwtU5wCfbZ/CTTP2xfEm7+</div><div>yobkXKSHl1BKffGaagniSKBlL9K2WOhSv/u0rxgYBQTp5eeg2DQY4OC0B67GfZVa</div><div>ABSkJy3ZraqXoJwVkrTREVaWzRBXayy0h9V17QrNpwAfYIvlUy839/NhdwOCBp4P</div><div>qTcTvzy8doGIKrCaChx6wTAwPbe6YoKEV6fxJuLeUovAXi2vQR3Xfiwiy3UY/Hre</div><div>kOUH/wmqWS2tAoIBADvrM94oG/uRIGipY0+6lxT8354KJqMtemfhD/0kH4BIQV4p</div><div>/aiOXJVZ55S+4Ww0qUZMvZw7vTB7oRsTHu1sR3DhLIVLl9jiK964lRfJYwgG3aiU</div><div>9mv628P0OJUdTdrPt7atAe0fDRWQRGIijrchlxdYSWeMFVREiTjdW36vf5yrwuH8</div><div>eG0CU5UPWJdpGJQdOLHG9/x5rLeFrPDQhlXw7K1zrd8Ob7GzHH78OPQJTu+JJlo9</div><div>LKQFlCJlF3FZ6vEoq5q+UbbrHYDkt1nAknyphEnhtnDBy8ixjCQcgRTRdIZ4Hsvf</div><div>vx7tlqkNEybNZpjZIaXevBPpaLGsaZp+ML3wwiECggEAGFTVfOqa+0kirra8UZWe</div><div>wDV3xdeT81NNy8CSJWDmiZtN5wg37pKphvmOcmYIiSiRtxxEvBrf/d6CdVTQSPQ8</div><div>3Jbvf690dzV0NcIhEq/Z+1OVKgnvWL8FxSpHASsyjvV2JK6hLzJFfWAeEynBKzyT</div><div>0yEaK2WrIbTamxfgCjiawTPxjlVj9QNF75X6anuvYZT+PbiPNWYRWYyez7MnXDiv</div><div>RM36a8EuaqaH95EWKFk6cJ8EO4tTa/eIXQ5GkYB06vqxW9knjoxBMVtR0DFTud33</div><div>rGHtdoBnh2Zmo227gFZZxNbdfwfKdFCOaP6cTOmuhwGH/Ka2Cph9WMzLVKHHMjMm</div><div>tQKCAQEAypfaWmZzsm+AFAGTgN4QkA6mYeSqYrUXIYZgsz/dXg6k2gh5hjQcejXP</div><div>41es04/Sr3O7DXIWflvuA22dUK+D8RZsk2uCma8vyZO0WvbZJ+NUu5cSOZx23h6L</div><div>6v1RC9+lz82OvQkYGDABpULIQkOrpR1L+4ScOIbYowro+QSieQcmokXkGmSB4fyC</div><div>WwuCue9/PIFwkOrO6EhEMpSYkWpP05ifmCuuABGxk9ORaVibs7pe+gQNSOlV4fbh</div><div>Yi8GC9Uf75wvjsstPB7Qw2AI1gljWVtcLRhu1okNWf92ju349vJ6AQRgwS2PlGX+</div><div>lxQNAG7MOwN3TxD785Y30yppAO2UXQ==</div><div>-----END PRIVATE KEY-----[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openssl genrsa -out private.pem 4096</div><div>Generating RSA private key, 4096 bit long modulus</div><div>.................++</div><div>.............................................++</div><div>e is 65537 (0x10001)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openssl pkcs8 -topk8 -in private.pem -out private.pk8 -nocrypt</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# PRIVATE_REF=$(openstack secret store \</div><div>&gt;       --secret-type private \</div><div>&gt;       --name 'Private Key for Certificate' \</div><div>&gt;       --file private.pk8 \</div><div>&gt;       -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openssl req -new -x509 -days 365 -key private.pk8 -out cert.pem</div><div>You are about to be asked to enter information that will be incorporated</div><div>into your certificate request.</div><div>What you are about to enter is what is called a Distinguished Name or a DN.</div><div>There are quite a few fields but you can leave some blank</div><div>For some fields there will be a default value,</div><div>If you enter '.', the field will be left blank.</div><div>-----</div><div>Country Name (2 letter code) [XX]:KR</div><div>State or Province Name (full name) []:</div><div>Locality Name (eg, city) [Default City]:</div><div>Organization Name (eg, company) [Default Company Ltd]:</div><div>Organizational Unit Name (eg, section) []:</div><div>Common Name (eg, your name or your server's hostname) []:</div><div>Email Address []:</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# CERT_REF=$(openstack secret store \</div><div>&gt;       --secret-type certificate \</div><div>&gt;       --name 'myhost.com certificate' \</div><div>&gt;       --file cert.pem \</div><div>&gt;       -c secret_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# CONTAINER_REF=$(openstack secret container create \</div><div>&gt;       --type certificate \</div><div>&gt;       --name 'Self-signed Certificate Bundle' \</div><div>&gt;       --secret "certificate=$CERT_REF" \</div><div>&gt;       --secret "private_key=$PRIVATE_REF" \</div><div>&gt;       -c container_ref -f value)</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret container get $CONTAINER_REF</div><div>+------------------------+-------------------------------------------------------------+</div><div>| Field                  | Value                                                       |</div><div>+------------------------+-------------------------------------------------------------+</div><div>| container_ref          | https://127.0.0.1:9311/v1/containers/5a69a4b4-46d1-4872-9d2 |</div><div>|                        | 0-647ee99e32bf                                              |</div><div>| name                   | Self-signed Certificate Bundle                              |</div><div>| created                | 2017-05-09 21:26:31+00:00                                   |</div><div>| status                 | ACTIVE                                                      |</div><div>| type                   | certificate                                                 |</div><div>| certificate            | https://127.0.0.1:9311/v1/secrets/1ca4b2e2-aaf4-4227-8eb0-0 |</div><div>|                        | 935fb91819e                                                 |</div><div>| intermediates          | None                                                        |</div><div>| private_key            | https://127.0.0.1:9311/v1/secrets/15becc2b-                 |</div><div>|                        | c5a0-43fe-b699-8f655eb7e719                                 |</div><div>| private_key_passphrase | None                                                        |</div><div>| consumers              | None                                                        |</div><div>+------------------------+-------------------------------------------------------------+</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# firewall-cmd --zone=public --add-port=8000/tcp --permanent</div><div>success</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# firewall-cmd --reload</div><div>success</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# source /root/new_flask/flask_app_venv/bin/activate</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# SECRET=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]#</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# openstack secret store --payload $SECRET</div><div>+---------------+----------------------------------------------------------------------+</div><div>| Field         | Value                                                                |</div><div>+---------------+----------------------------------------------------------------------+</div><div>| secret_ref    | https://127.0.0.1:9311/v1/secrets/7d707fe6-6f3c-                     |</div><div>|               | 416a-8991-62077fff79ac                                               |</div><div>| name          | None                                                                 |</div><div>| created       | 2017-05-09 21:27:17+00:00                                            |</div><div>| status        | ACTIVE                                                               |</div><div>| content_types | {u'default': u'text/plain'}                                          |</div><div>| algorithm     | aes                                                                  |</div><div>| bit_length    | 256                                                                  |</div><div>| secret_type   | opaque                                                               |</div><div>| mode          | cbc                                                                  |</div><div>| expiration    | None                                                                 |</div><div>+---------------+----------------------------------------------------------------------+</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# echo $SECRET</div><div>jQvuUrGPQrOlE94lbHbG591GDhAKfeiw</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# export OS_SECRET_UUID=7d707fe6-6f3c-416a-8991-62077fff79ac</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 ~]# cd /root/new_flask/hide-your-tweets</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 hide-your-tweets]# pip install -r requirements.txt</div><div>Collecting Flask==0.10.0 (from -r requirements.txt (line 1))</div><div>  Downloading Flask-0.10.tar.gz (544kB)</div><div>    100% |████████████████████████████████| 552kB 1.2MB/s</div><div>Collecting Flask-WTF==0.12 (from -r requirements.txt (line 2))</div><div>  Downloading Flask_WTF-0.12-py2-none-any.whl</div><div>Collecting WTForms==2.1 (from -r requirements.txt (line 3))</div><div>  Downloading WTForms-2.1.zip (553kB)</div><div>    100% |████████████████████████████████| 563kB 1.1MB/s</div><div>Requirement already satisfied (use --upgrade to upgrade): pytz in /usr/lib/python2.7/site-packages (from -r requirements.txt (line 4))</div><div>Requirement already satisfied (use --upgrade to upgrade): cryptography in /usr/lib64/python2.7/site-packages (from -r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): keystoneauth1 in /usr/lib/python2.7/site-packages (from -r requirements.txt (line 6))</div><div>Requirement already satisfied (use --upgrade to upgrade): python-barbicanclient in /usr/lib/python2.7/site-packages (from -r requirements.txt (line 7))</div><div>Requirement already satisfied (use --upgrade to upgrade): oslo.context in /usr/lib/python2.7/site-packages (from -r requirements.txt (line 8))</div><div>Collecting castellan (from -r requirements.txt (line 9))</div><div>  Downloading castellan-0.7.0-py2.py3-none-any.whl (71kB)</div><div>    100% |████████████████████████████████| 71kB 3.5MB/s</div><div>Collecting packaging&gt;=16.8 (from -r requirements.txt (line 10))</div><div>  Downloading packaging-16.8-py2.py3-none-any.whl</div><div>Collecting Werkzeug&gt;=0.7 (from Flask==0.10.0-&gt;-r requirements.txt (line 1))</div><div>  Downloading Werkzeug-0.12.1-py2.py3-none-any.whl (312kB)</div><div>    100% |████████████████████████████████| 317kB 1.5MB/s</div><div>Requirement already satisfied (use --upgrade to upgrade): Jinja2&gt;=2.4 in /usr/lib/python2.7/site-packages (from Flask==0.10.0-&gt;-r requirements.txt (line 1))</div><div>Collecting itsdangerous&gt;=0.21 (from Flask==0.10.0-&gt;-r requirements.txt (line 1))</div><div>  Downloading itsdangerous-0.24.tar.gz (46kB)</div><div>    100% |████████████████████████████████| 51kB 4.9MB/s</div><div>Requirement already satisfied (use --upgrade to upgrade): idna&gt;=2.0 in /usr/lib/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): pyasn1&gt;=0.1.8 in /usr/lib/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): six&gt;=1.4.1 in /usr/lib/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Collecting setuptools&gt;=11.3 (from cryptography-&gt;-r requirements.txt (line 5))</div><div>  Downloading setuptools-35.0.2-py2.py3-none-any.whl (390kB)</div><div>    100% |████████████████████████████████| 399kB 1.4MB/s</div><div>Requirement already satisfied (use --upgrade to upgrade): enum34 in /usr/lib/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): ipaddress in /usr/lib/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): cffi&gt;=1.4.1 in /usr/lib64/python2.7/site-packages (from cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): oslo.utils&gt;=3.20.0 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): oslo.config&gt;=3.22.0 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): Babel!=2.4.0,&gt;=2.3.4 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): oslo.i18n&gt;=2.1.0 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): oslo.log&gt;=3.22.0 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): pbr!=2.1.0,&gt;=2.0.0 in /usr/lib/python2.7/site-packages (from castellan-&gt;-r requirements.txt (line 9))</div><div>Requirement already satisfied (use --upgrade to upgrade): pyparsing in /usr/lib/python2.7/site-packages (from packaging&gt;=16.8-&gt;-r requirements.txt (line 10))</div><div>Requirement already satisfied (use --upgrade to upgrade): markupsafe in /usr/lib64/python2.7/site-packages (from Jinja2&gt;=2.4-&gt;Flask==0.10.0-&gt;-r requirements.txt (line 1))</div><div>Requirement already satisfied (use --upgrade to upgrade): appdirs&gt;=1.4.0 in /usr/lib/python2.7/site-packages (from setuptools&gt;=11.3-&gt;cryptography-&gt;-r requirements.txt (line 5))</div><div>Requirement already satisfied (use --upgrade to upgrade): pycparser in /usr/lib/python2.7/site-packages (from cffi&gt;=1.4.1-&gt;cryptography-&gt;-r requirements.txt (line 5))</div><div>Installing collected packages: Werkzeug, itsdangerous, Flask, WTForms, Flask-WTF, castellan, packaging, setuptools</div><div>  Running setup.py install for itsdangerous ... done</div><div>  Running setup.py install for Flask ... done</div><div>  Running setup.py install for WTForms ... done</div><div>  Found existing installation: setuptools 0.9.8</div><div>    Uninstalling setuptools-0.9.8:</div><div>      Successfully uninstalled setuptools-0.9.8</div><div>Successfully installed Flask-0.10 Flask-WTF-0.12 WTForms-2.1 Werkzeug-0.12.1 castellan-0.7.0 itsdangerous-0.24 packaging-16.8 setuptools-35.0.2</div><div>You are using pip version 8.1.2, however version 9.0.1 is available.</div><div>You should consider upgrading via the 'pip install --upgrade pip' command.</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 hide-your-tweets]# cd /root/new_flask/hide-your-tweets/src</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]# python server.py</div><div> * Running on http://0.0.0.0:8000/ (Press CTRL+C to quit)</div><div>deactivate^C(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]#</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]#</div><div>(new_env)[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]# deactivate</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]# /root/convert_to_dogtag_with_hsm.sh</div><div>[root@student-d26cac46-0080-4eca-9b8e-c92b7f6993d6 src]# systemctl restart httpd.service</div><div><br/></div><div><br/></div></body></html>